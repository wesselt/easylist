<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <title>EasyList - Single URL for your Bunq Data</title>
  </head>
  <body>
    <div class="alert alert-warning" role="alert" id="div_alert"
        style="display: none; ">
      <div id="alert_text"></div>
    </div>
    <div class="container">
      <div class="row" id="row_sheet">
        <div class="col-xs">
          <br/>
          <h5>Example self-updating Google sheet with the importdata function:</h5>
          <br/>
          <img src="img//google-sheet-importdata.png" width="800px"/>
        </div>
      </div>
      <div class="row" id="row_python">
        <div class="col-xs">
          <br/>
          <h5>Example Python script with the requests library:</h5>
          <br/>
          <img src="img/python-requests.png" width="800px" />
        </div>
      </div>
       <div class="row" id="row_button">
        <div class="col-xs">
          <br/>
          <list>
          <li>You'll be redirected to BUNQ for approval</li>
          <li>Grant access to one or more accounts using the BUNQ app</li>
          <li>A URL will be created for you</li>
          <li>Anyone with the URL can request transactions</li>
          </list>
          <br/>
          <a class="btn btn-info" role="button" id="btn">Request My Personal URL</a>
        </div>
      </div>
      <div class="row" id="row_urls" style="display: none; ">
        <div class="col-xs">
          <br/>
          <br/>
          <h5>Here are your hyperlinks!  The first returns a CSV file, the second returns JSON.</h5>
          <a id="url_csv" target="_blank">
            <img src="img/csv.png">
          </a>
          <br/>
          <a id="url_json" target="_blank">
            <img src="img/json.png">
          </a>
          <br/>
          <br/>
          <a class="btn btn-info" role="button" 
             href="https://easylist.aule.net">Home</a>
        </div>
      </div>
      <div class="row">
        <div style="color:gray; ">
        <br/>
        <br/>
        <a href="https://github.com/wesselt/easylist">Source code available at github.</a>
        </div>
      </div>
    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" crossorigin="anonymous"></script>

    <script type="text/javascript">

var getUrlParameter = function getUrlParameter(sParam) {
  var sPageURL = window.location.search.substring(1),
      sURLVariables = sPageURL.split('&'),
      sParameterName,
      i;

  for (i = 0; i < sURLVariables.length; i++) {
    sParameterName = sURLVariables[i].split('=');

    if (sParameterName[0] === sParam) {
      return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
    }
  }
};

var alert = function(msg) {
  $('#alert_text').html(msg);
  $('#div_alert').css('display', 'block');
}

$(window).on('load', function() {
  var error = getUrlParameter("error");
  if (error) {
    alert("<strong>An error occured:</strong> " + error);
  } else {
    var guid = getUrlParameter("state");
    if (!guid) {
      guid = getUrlParameter("guid");
    }
    var code = getUrlParameter("code");
    if (code) {
      $.getJSON({url: 'backend?code=' + code + '&guid=' + guid, 
                 success: function(result) {
        if (result["success"] === "success") {
          var csv_url = 'https://easylist.aule.net/generate?guid=' + guid;
          $('#url_csv').append(csv_url);
          $('#url_csv').attr("href", csv_url);
          var json_url = 'https://easylist.aule.net/json?guid=' + guid;
          $('#url_json').append(json_url);
          $('#url_json').attr("href", json_url);
          $('#row_sheet, #row_python, #row_button').css('display', 'none');
          $('#row_urls').css('display', 'block');
        } else {
          alert(result["error"]);
        }
      }});
    }
  }

  $.getJSON({url: 'backend?get_guid=1', success: function(result) {
    var url = 'https://oauth.bunq.com/auth?' +
              'response_type=code&' +
              'client_id=88ad9f89f0081f7d17a9552a7ff8403b48882a521dcd5a7d7229aab16e721386&' +
              'redirect_uri=https://easylist.aule.net/&' +
              'state=' + result["new_guid"];
    $('#btn').attr('href', url);
  }});
});

    </script>
  </body>
</html>
